package com.weidi.chat;

import java.util.List;

import android.content.BroadcastReceiver;
import android.content.Context;
import android.content.Intent;
import android.content.IntentFilter;
import android.os.Bundle;
import android.os.Message;
import android.view.View;
import android.view.View.OnClickListener;
import android.widget.ImageView;
import android.widget.LinearLayout;
import android.widget.TextView;

import com.lidroid.xutils.ViewUtils;
import com.lidroid.xutils.view.annotation.ViewInject;
import com.weidi.R;
import com.weidi.bean.Msg;
import com.weidi.bean.User;
import com.weidi.common.base.BaseActivity;
import com.weidi.db.ChatMsgDao;
import com.weidi.db.SessionDao;
import com.weidi.db.VCardDao;
import com.weidi.util.Const;
import com.weidi.util.PreferencesUtils;
import com.weidi.view.CircleImageView;
import com.weidi.view.DropdownListView;

/**
 * @author luochangdong E-mail: 2270333671@qq.com
 * @date 创建时间：2015-7-16 下午3:07:25
 * @Description 1.0 新聊天界面
 */
public class NewChatActivity extends BaseActivity implements OnClickListener {

	public static final String TAG = NewChatActivity.class.getSimpleName();
	@ViewInject(R.id.tvChatLeft)
	ImageView tvChatLeft;
	@ViewInject(R.id.tvChatTitle)
	TextView tvChatTitle;
	@ViewInject(R.id.tvChatRight)
	CircleImageView tvChatRight;
	@ViewInject(R.id.image_face)
	ImageView image_face;
	@ViewInject(R.id.image_add)
	ImageView image_add;
	@ViewInject(R.id.tvVoice)
	LinearLayout tvVoice;
	@ViewInject(R.id.send_sms)
	LinearLayout send_sms;
	@ViewInject(R.id.btnChatKeyboard)
	LinearLayout btnChatKeyboard;
	@ViewInject(R.id.chat_face_container)
	LinearLayout chat_face_container;
	@ViewInject(R.id.chat_add_container)
	LinearLayout chat_add_container;
	@ViewInject(R.id.message_chat_listview)
	DropdownListView message_chat_listview;

	private VCardDao userDao;
	private ChatMsgDao msgDao;
	private SessionDao sessionDao;
	private List<Msg> listMsg;
	private User friend;
	private int offset;
	private String YOU, I;

	@Override
	protected void initView(Bundle savedInstanceState) {
		setContentView(R.layout.main_chat);
		ViewUtils.inject(this);
		String username = getIntent().getStringExtra("from");
		initBroadcast();
	
		initData(username);
		initAdapter();
		// 更新与该用户的聊天记录全部为已读
		updateMsgToReaded();
	}

	private void initAdapter() {
		// TODO Auto-generated method stub
		
	}

	private void initBroadcast() {
		mReceiver = new BroadcastReceiver() {

			@Override
			public void onReceive(Context context, Intent intent) {
				

			}
		};
		mLocalBroadcastManager.registerReceiver(mReceiver, new IntentFilter(
				Const.ACTION_NEW_MSG));
		mLocalBroadcastManager.registerReceiver(mReceiver, new IntentFilter(Const.ACTION_MSG_OPER));
	}

	private void updateMsgToReaded() {
		new Thread(new Runnable() {
			@Override
			public void run() {
				msgDao.updateAllMsgToRead(YOU, I);
			}
		}).start();
	}

	private void initData(String username) {
		userDao = VCardDao.getInstance();
		msgDao = ChatMsgDao.getInstance();
		sessionDao = SessionDao.getInstance();
		offset = 0;
		I = PreferencesUtils.getSharePreStr("weidi");
		YOU = username;
		friend = userDao.getUser(username);
		if (friend != null) {
			tvChatTitle.setText(friend.getNickname() == null ? username
					: friend.getNickname());
		}
		listMsg = msgDao.queryMsg(YOU, I, offset);
	}

	@Override
	protected void setListener() {
		tvChatRight.setOnClickListener(this);
		tvChatLeft.setOnClickListener(this);
		image_face.setOnClickListener(this);
	}

	@Override
	protected void afterViews(Bundle savedInstanceState) {
		// TODO Auto-generated method stub

	}

	@Override
	protected void handleMsg(Message msg) {
		// TODO Auto-generated method stub

	}

	@Override
	public void onClick(View v) {
		// TODO Auto-generated method stub

	}
	
	@Override
	protected void onDestroy() {
	    mLocalBroadcastManager.unregisterReceiver(mReceiver);
		super.onDestroy();
	}

}
